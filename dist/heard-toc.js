/* Heard Custom Code - toc */
"use strict";(()=>{var M=/\[heard-toc-omit\]/gi,b=/\[heard-toc-h([2-6])\]/gi;function O(e){return e.toLowerCase().trim().replace(/[^\w\s-]/g,"").replace(/[\s_-]+/g,"-").replace(/^-+|-+$/g,"")}function q(e){let t=e,o=!1,n;M.test(e)&&(o=!0,t=t.replace(M,"").trim());let r=b.exec(e);return r&&(n=parseInt(r[1],10),t=t.replace(b,"").trim()),{cleanText:t,omitted:o,overrideLevel:n}}function $(e){let o=e.tagName.toLowerCase().match(/^h([2-6])$/);return o?parseInt(o[1],10):0}function C(){let e=document.querySelectorAll('[heard-toc-element="contents"]');if(e.length===0)return console.warn('[Heard TOC] No elements with heard-toc-element="contents" found'),[];let t=[],o=new Map;return e.forEach(n=>{n.querySelectorAll("h2, h3, h4, h5, h6").forEach(l=>{let u=$(l);if(u===0)return;let a=l.textContent||"",{cleanText:i,omitted:s,overrideLevel:m}=q(a);if(!i)return;let d=m||u,f=O(i);f||(f=`heading-${t.length+1}`);let c=f;if(o.has(c)){let p=o.get(c)+1;o.set(c,p),c=`${f}-${p}`}else o.set(c,1);l.id=c,t.push({el:l,level:d,text:i,id:c,omitted:s})})}),t}function B(e){let t=[".fs-toc_link-wrapper",'[class*="toc_link-wrapper"]','[class*="toc-wrapper"]',".heard-toc-wrapper"];for(let o of t){let n=Array.from(e.querySelectorAll(o));if(n.length>0)return n}return Array.from(e.children).filter(o=>o instanceof HTMLElement)}function S(e){let t=[".fs-toc_link",'a[class*="toc_link"]',"a",'[heard-toc-element="link"]'];for(let o of t){let n=e.querySelector(o);if(n)return n}return e.tagName==="A"||e.hasAttribute("href")?e:null}function N(e,t){let o=[`.fs-toc_link-h${t}`,`h${t}[class*="toc_link"]`,`h${t}`];for(let n of o){let r=e.querySelector(n);if(r)return r}return null}function _(){let e=document.querySelector('[heard-toc-element="table"]')||document.querySelector(".fs-toc_link-content")||document.querySelector('[class*="toc_link-content"]');if(!e)return console.warn('[Heard TOC] No TOC container found. Add heard-toc-element="table" or .fs-toc_link-content'),null;let t=B(e),o=document.querySelector('[heard-toc-element="link"]')||e.querySelector(".fs-toc_link")||e.querySelector("a"),n=t.length>0?t[0]:e.querySelector(".fs-toc_link-wrapper")||e.firstElementChild;return!o||!n?(console.warn("[Heard TOC] Could not find template elements"),null):{container:e,wrapperElements:t,linkTemplate:o,wrapperTemplate:n}}function R(e,t){if(e.tagName==="A")e.href=`#${t.id}`;else{let n=e.querySelector("a");n?n.href=`#${t.id}`:(e.setAttribute("data-toc-link",t.id),e.style.cursor="pointer",e.addEventListener("click",()=>{let r=document.getElementById(t.id);r&&r.scrollIntoView({behavior:"smooth",block:"start"})}))}let o=N(e,t.level);if(o)o.textContent=t.text;else if(e.tagName==="A")e.textContent=t.text;else{let n=e.querySelector("a");n?n.textContent=t.text:e.textContent=t.text}}function g(e,t){e.classList.remove("is-h2","is-h3","is-h4","is-h5","is-h6"),t>=3&&t<=6&&e.classList.add(`is-h${t}`)}function D(e,t,o){if(o<e.wrapperElements.length){let l=e.wrapperElements[o];return g(l,t.level),l}let n=e.wrapperTemplate.cloneNode(!0);n.removeAttribute("heard-toc-element"),g(n,t.level);let r=S(n);return r&&r.hasAttribute("heard-toc-element"),n}function Y(e,t){let o=e.filter(i=>!i.omitted);if(o.length===0){t.wrapperElements.forEach(i=>{i.style.display="none"});return}let n=[],r=new Set,l=0,u=[...t.wrapperElements];o.forEach(i=>{let s;l<u.length?(s=u[l],l++,s.parentElement&&s.parentElement!==t.container&&s.remove()):(s=D(t,i,l),l++),g(s,i.level),s.style.display="";let m=S(s);if(!m){m=t.linkTemplate.cloneNode(!0),m.removeAttribute("heard-toc-element");let d=s;for(;d.children.length>0;){let f=d.children[0];if(f.tagName==="DIV"||f.tagName==="SPAN")d=f;else break}d.appendChild(m)}for(R(m,i);n.length>0&&n[n.length-1].level>=i.level;)n.pop();n.length>0?n[n.length-1].wrapper.appendChild(s):t.container.appendChild(s),n.push({level:i.level,wrapper:s}),r.add(s)}),u.forEach(i=>{r.has(i)||(i.style.display="none")});let a=t.container.querySelector('[heard-toc-element="link"]');if(a){let i=a.closest(".fs-toc_link-wrapper")||a.parentElement;r.has(i)||a.remove()}}function k(e){if(e.length===0)return console.warn("[Heard TOC] No headings found to build TOC"),!1;let t=_();if(!t)return!1;Y(e,t);let o=e.filter(n=>!n.omitted).length;return console.log(`[Heard TOC] Populated ${o} TOC item(s) using existing DOM elements`),!0}function E(e){let t=parseFloat(e);return e.includes("rem")||e.includes("em")?t*16:e.includes("px")?t:e.includes("vh")?t/100*window.innerHeight:t}function W(){let e=document.querySelector('[heard-toc-element="contents"]')||document.querySelector('[fs-toc-element="contents"]');if(!e)return{hideUrlHash:!1};let t=e.getAttribute("fs-toc-offsettop")||e.getAttribute("heard-toc-offsettop")||void 0,o=e.getAttribute("fs-toc-offsetbottom")||e.getAttribute("heard-toc-offsetbottom")||void 0,n=e.getAttribute("fs-toc-hideurlhash")==="true"||e.getAttribute("heard-toc-hideurlhash")==="true";return{offsetTop:t,offsetBottom:o,hideUrlHash:n}}function H(e){let t=document.querySelector(`a[href="#${e}"]`);return t||document.querySelector(`[data-toc-link="${e}"]`)}function V(e,t){let o=null;for(let n=0;n<t.length&&t[n].id!==e.id;n++)t[n].level<e.level&&!t[n].omitted&&(o=t[n]);return o}function L(e,t){if(e.level===2)return!0;let o=V(e,t);if(!o)return!0;let n=o.el.getBoundingClientRect(),r=window.scrollY,l=window.scrollY+n.top,u=window.scrollY+n.bottom;return l<=r+300||l>=r&&u<=r+window.innerHeight}function T(e,t){if(t.forEach(o=>{let n=H(o.id);n&&n.classList.remove("w--current")}),e){let o=t.find(n=>n.id===e);if(o&&L(o,t)){let n=H(e);if(n){n.classList.add("w--current");let r=n.closest('[heard-toc-element="ix-trigger"]')?.parentElement||n.querySelector('[heard-toc-element="ix-trigger"]');r&&r.dispatchEvent(new MouseEvent("click",{bubbles:!0}))}}}}function U(e,t){let o=document.getElementById(e);if(!o)return;let n=t.offsetTop?E(t.offsetTop):0,r=t.offsetBottom?E(t.offsetBottom):0,l=o.getBoundingClientRect(),u=window.scrollY+l.top-n;if(window.scrollTo({top:Math.max(0,u),behavior:"smooth"}),!t.hideUrlHash){let a=new URL(window.location.href);a.hash=e,window.history.replaceState(null,"",a.toString())}}function P(e,t){e.forEach(o=>{let n=H(o.id);n&&n.addEventListener("click",r=>{let u=n.tagName==="A"?n.href:null;u&&u.includes("#")&&r.preventDefault(),U(o.id,t)})})}function x(e){if(e.length===0)return;let t=W(),o=t.offsetTop?E(t.offsetTop):0,n=t.offsetBottom?E(t.offsetBottom):0,r=o>0?`-${o}px`:"0px",l=n>0?`-${n}px`:"0px",u=`${r} 0px ${l} 0px`,a=null,i=new IntersectionObserver(m=>{let d=null,f=0;for(let c of m)c.isIntersecting&&c.intersectionRatio>f&&(f=c.intersectionRatio,d=c);if(d!==null){let p=d.target.id;p&&p!==a&&(a=p,T(a,e))}else{let c=window.scrollY+o,p=null,w=1/0;for(let h of e){if(h.omitted||!L(h,e))continue;let I=h.el.getBoundingClientRect(),y=window.scrollY+I.top,v=Math.abs(y-c);y<=c+100&&v<w&&(w=v,p=h)}p!==null&&p.id!==a&&(a=p.id,T(a,e))}},{rootMargin:u,threshold:[0,.1,.5,1]});e.forEach(m=>{i.observe(m.el)}),P(e,t);let s=()=>{let m=window.scrollY+o,d=null;for(let f of e){if(f.omitted||!L(f,e))continue;let c=f.el.getBoundingClientRect();if(window.scrollY+c.top<=m+100)d=f.id;else break}d&&T(d,e)};s(),window.addEventListener("scroll",s,{passive:!0})}function A(){try{let e=C();if(e.length===0){console.warn('[Heard TOC] No headings found. Make sure you have elements with heard-toc-element="contents" containing h2-h6 headings.');return}if(!k(e)){console.warn("[Heard TOC] Failed to build TOC. Check your template structure.");return}x(e),console.log(`[Heard TOC] Initialized with ${e.length} heading(s)`)}catch(e){console.error("[Heard TOC] Error initializing:",e)}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",A):A();})();

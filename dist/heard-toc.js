/* Heard Custom Code - toc */
"use strict";(()=>{var M=/\[heard-toc-omit\]/gi,v=/\[heard-toc-h([2-6])\]/gi;function I(e){return e.toLowerCase().trim().replace(/[^\w\s-]/g,"").replace(/[\s_-]+/g,"-").replace(/^-+|-+$/g,"")}function q(e){let t=e,o=!1,n;M.test(e)&&(o=!0,t=t.replace(M,"").trim());let r=v.exec(e);return r&&(n=parseInt(r[1],10),t=t.replace(v,"").trim()),{cleanText:t,omitted:o,overrideLevel:n}}function $(e){let o=e.tagName.toLowerCase().match(/^h([2-6])$/);return o?parseInt(o[1],10):0}function C(){let e=document.querySelectorAll('[heard-toc-element="contents"]');if(e.length===0)return console.warn('[Heard TOC] No elements with heard-toc-element="contents" found'),[];let t=[],o=new Map;return e.forEach(n=>{n.querySelectorAll("h2, h3, h4, h5, h6").forEach(l=>{let c=$(l);if(c===0)return;let s=l.textContent||"",{cleanText:i,omitted:a,overrideLevel:m}=q(s);if(!i)return;let d=m||c,u=I(i);u||(u=`heading-${t.length+1}`);let f=u;if(o.has(f)){let p=o.get(f)+1;o.set(f,p),f=`${u}-${p}`}else o.set(f,1);l.id=f,t.push({el:l,level:d,text:i,id:f,omitted:a})})}),t}function B(e){let t=[".fs-toc_link-wrapper",'[class*="toc_link-wrapper"]','[class*="toc-wrapper"]',".heard-toc-wrapper"];for(let o of t){let n=Array.from(e.querySelectorAll(o));if(n.length>0)return n}return Array.from(e.children).filter(o=>o instanceof HTMLElement)}function S(e){let t=[".fs-toc_link",'a[class*="toc_link"]',"a",'[heard-toc-element="link"]'];for(let o of t){let n=e.querySelector(o);if(n)return n}return e.tagName==="A"||e.hasAttribute("href")?e:null}function N(e,t){let o=[`.fs-toc_link-h${t}`,`h${t}[class*="toc_link"]`,`h${t}`];for(let n of o){let r=e.querySelector(n);if(r)return r}return null}function _(){let e=document.querySelector('[heard-toc-element="table"]')||document.querySelector(".fs-toc_link-content")||document.querySelector('[class*="toc_link-content"]');if(!e)return console.warn('[Heard TOC] No TOC container found. Add heard-toc-element="table" or .fs-toc_link-content'),null;let t=B(e),o=document.querySelector('[heard-toc-element="link"]')||e.querySelector(".fs-toc_link")||e.querySelector("a"),n=t.length>0?t[0]:e.querySelector(".fs-toc_link-wrapper")||e.firstElementChild;return!o||!n?(console.warn("[Heard TOC] Could not find template elements"),null):{container:e,wrapperElements:t,linkTemplate:o,wrapperTemplate:n}}function R(e,t){if(e.tagName==="A")e.href=`#${t.id}`;else{let n=e.querySelector("a");n?n.href=`#${t.id}`:(e.setAttribute("data-toc-link",t.id),e.style.cursor="pointer",e.addEventListener("click",()=>{let r=document.getElementById(t.id);r&&r.scrollIntoView({behavior:"smooth",block:"start"})}))}let o=N(e,t.level);if(o)o.textContent=t.text;else if(e.tagName==="A")e.textContent=t.text;else{let n=e.querySelector("a");n?n.textContent=t.text:e.textContent=t.text}}function E(e,t){e.classList.remove("is-h2","is-h3","is-h4","is-h5","is-h6"),t>=3&&t<=6&&e.classList.add(`is-h${t}`)}function D(e,t,o){if(o<e.wrapperElements.length){let l=e.wrapperElements[o];return E(l,t.level),l}let n=e.wrapperTemplate.cloneNode(!0);n.removeAttribute("heard-toc-element"),E(n,t.level);let r=S(n);return r&&r.hasAttribute("heard-toc-element"),n}function Y(e,t){let o=e.filter(i=>!i.omitted);if(o.length===0){t.wrapperElements.forEach(i=>{i.style.display="none"});return}let n=[],r=new Set,l=0,c=[...t.wrapperElements];o.forEach(i=>{let a;l<c.length?(a=c[l],l++,a.parentElement&&a.parentElement!==t.container&&a.remove()):(a=D(t,i,l),l++),E(a,i.level),a.style.display="";let m=S(a);if(!m){m=t.linkTemplate.cloneNode(!0),m.removeAttribute("heard-toc-element");let d=a;for(;d.children.length>0;){let u=d.children[0];if(u.tagName==="DIV"||u.tagName==="SPAN")d=u;else break}d.appendChild(m)}for(R(m,i);n.length>0&&n[n.length-1].level>=i.level;)n.pop();n.length>0?n[n.length-1].wrapper.appendChild(a):t.container.appendChild(a),n.push({level:i.level,wrapper:a}),r.add(a)}),c.forEach(i=>{r.has(i)||(i.style.display="none")});let s=t.container.querySelector('[heard-toc-element="link"]');if(s){let i=s.closest(".fs-toc_link-wrapper")||s.parentElement;r.has(i)||s.remove()}}function k(e){if(e.length===0)return console.warn("[Heard TOC] No headings found to build TOC"),!1;let t=_();if(!t)return!1;Y(e,t);let o=e.filter(n=>!n.omitted).length;return console.log(`[Heard TOC] Populated ${o} TOC item(s) using existing DOM elements`),!0}function g(e){let t=parseFloat(e);return e.includes("rem")||e.includes("em")?t*16:e.includes("px")?t:e.includes("vh")?t/100*window.innerHeight:t}function W(){let e=document.querySelector('[heard-toc-element="table"]')||document.querySelector('[fs-toc-element="table"]')||document.querySelector(".fs-toc_link-content"),t,o,n=!1;if(e&&(t=e.getAttribute("fs-toc-offsettop")||e.getAttribute("heard-toc-offsettop")||void 0,o=e.getAttribute("fs-toc-offsetbottom")||e.getAttribute("heard-toc-offsetbottom")||void 0,n=e.getAttribute("fs-toc-hideurlhash")==="true"||e.getAttribute("heard-toc-hideurlhash")==="true"),!t&&!o){let r=document.querySelectorAll('[heard-toc-element="contents"], [fs-toc-element="contents"]');for(let l of r){let c=l.getAttribute("fs-toc-offsettop")||l.getAttribute("heard-toc-offsettop"),s=l.getAttribute("fs-toc-offsetbottom")||l.getAttribute("heard-toc-offsetbottom"),i=l.getAttribute("fs-toc-hideurlhash")==="true"||l.getAttribute("heard-toc-hideurlhash")==="true";if(c||s){t=c||void 0,o=s||void 0,n=i;break}i&&(n=!0)}}return{offsetTop:t,offsetBottom:o,hideUrlHash:n}}function H(e){let t=document.querySelector(`a[href="#${e}"]`);return t||document.querySelector(`[data-toc-link="${e}"]`)}function V(e,t){let o=null;for(let n=0;n<t.length&&t[n].id!==e.id;n++)t[n].level<e.level&&!t[n].omitted&&(o=t[n]);return o}function L(e,t){if(e.level===2)return!0;let o=V(e,t);if(!o)return!0;let n=o.el.getBoundingClientRect(),r=window.scrollY,l=window.scrollY+n.top,c=window.scrollY+n.bottom;return l<=r+300||l>=r&&c<=r+window.innerHeight}function T(e,t){if(t.forEach(o=>{let n=H(o.id);n&&n.classList.remove("w--current")}),e){let o=t.find(n=>n.id===e);if(o&&L(o,t)){let n=H(e);if(n){n.classList.add("w--current");let r=n.closest('[heard-toc-element="ix-trigger"]')?.parentElement||n.querySelector('[heard-toc-element="ix-trigger"]');r&&r.dispatchEvent(new MouseEvent("click",{bubbles:!0}))}}}}function U(e,t){let o=document.getElementById(e);if(!o)return;let n=t.offsetTop?g(t.offsetTop):0,r=t.offsetBottom?g(t.offsetBottom):0,l=o.getBoundingClientRect(),c=window.scrollY+l.top-n;if(window.scrollTo({top:Math.max(0,c),behavior:"smooth"}),!t.hideUrlHash){let s=new URL(window.location.href);s.hash=e,window.history.replaceState(null,"",s.toString())}}function P(e,t){e.forEach(o=>{let n=H(o.id);n&&n.addEventListener("click",r=>{let c=n.tagName==="A"?n.href:null;c&&c.includes("#")&&r.preventDefault(),U(o.id,t)})})}function A(e){if(e.length===0)return;let t=W(),o=t.offsetTop?g(t.offsetTop):0,n=t.offsetBottom?g(t.offsetBottom):0,r=o>0?`-${o}px`:"0px",l=n>0?`-${n}px`:"0px",c=`${r} 0px ${l} 0px`,s=null,i=new IntersectionObserver(m=>{let d=null,u=0;for(let f of m)f.isIntersecting&&f.intersectionRatio>u&&(u=f.intersectionRatio,d=f);if(d!==null){let p=d.target.id;p&&p!==s&&(s=p,T(s,e))}else{let f=window.scrollY+o,p=null,y=1/0;for(let h of e){if(h.omitted||!L(h,e))continue;let O=h.el.getBoundingClientRect(),w=window.scrollY+O.top,b=Math.abs(w-f);w<=f+100&&b<y&&(y=b,p=h)}p!==null&&p.id!==s&&(s=p.id,T(s,e))}},{rootMargin:c,threshold:[0,.1,.5,1]});e.forEach(m=>{i.observe(m.el)}),P(e,t);let a=()=>{let m=window.scrollY+o,d=null;for(let u of e){if(u.omitted||!L(u,e))continue;let f=u.el.getBoundingClientRect();if(window.scrollY+f.top<=m+100)d=u.id;else break}d&&T(d,e)};a(),window.addEventListener("scroll",a,{passive:!0})}function x(){try{let e=C();if(e.length===0){console.warn('[Heard TOC] No headings found. Make sure you have elements with heard-toc-element="contents" containing h2-h6 headings.');return}if(!k(e)){console.warn("[Heard TOC] Failed to build TOC. Check your template structure.");return}A(e),console.log(`[Heard TOC] Initialized with ${e.length} heading(s)`)}catch(e){console.error("[Heard TOC] Error initializing:",e)}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",x):x();})();

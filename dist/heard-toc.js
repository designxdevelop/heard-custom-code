/* Heard Custom Code - toc */
"use strict";(()=>{var L=/\[heard-toc-omit\]/gi,v=/\[heard-toc-h([2-6])\]/gi;function A(e){return e.toLowerCase().trim().replace(/[^\w\s-]/g,"").replace(/[\s_-]+/g,"-").replace(/^-+|-+$/g,"")}function q(e){let t=e,n=!1,o;L.test(e)&&(n=!0,t=t.replace(L,"").trim());let r=v.exec(e);return r&&(o=parseInt(r[1],10),t=t.replace(v,"").trim()),{cleanText:t,omitted:n,overrideLevel:o}}function B(e){let n=e.tagName.toLowerCase().match(/^h([2-6])$/);return n?parseInt(n[1],10):0}function w(){let e=document.querySelectorAll('[heard-toc-element="contents"]');if(e.length===0)return console.warn('[Heard TOC] No elements with heard-toc-element="contents" found'),[];let t=[],n=new Map;return e.forEach(o=>{o.querySelectorAll("h2, h3, h4, h5, h6").forEach(l=>{let s=B(l);if(s===0)return;let i=l.textContent||"",{cleanText:f,omitted:p,overrideLevel:a}=q(i);if(!f)return;let m=a||s,d=A(f);d||(d=`heading-${t.length+1}`);let c=d;if(n.has(c)){let u=n.get(c)+1;n.set(c,u),c=`${d}-${u}`}else n.set(c,1);l.id=c,t.push({el:l,level:m,text:f,id:c,omitted:p})})}),t}function $(){let e=document.querySelector('[heard-toc-element="table"]')||document.querySelector(".fs-toc_sidebar");if(!e)return console.warn('[Heard TOC] No TOC table element found. Add heard-toc-element="table".'),null;let t=e.querySelector(".fs-toc_link-content")||e.querySelector('[class*="toc_link-content"]');if(!t){let o=e.querySelector(".fs-toc_link-wrapper")||e.querySelector('[class*="toc_link-wrapper"]');return o?M(e,e,o):(console.warn("[Heard TOC] No link-content container found inside TOC table."),null)}let n=t.querySelector(":scope > .fs-toc_link-wrapper")||t.querySelector(".fs-toc_link-wrapper");return n?M(e,t,n):(console.warn("[Heard TOC] No fs-toc_link-wrapper found inside link-content."),null)}function M(e,t,n){let o=Array.from(n.classList).filter(a=>!a.match(/^is-h[2-6]$/)),r=n.querySelector(":scope > a.fs-toc_link")||n.querySelector(":scope > a")||n.querySelector("a.fs-toc_link")||n.querySelector("a");if(!r)return console.warn("[Heard TOC] No anchor element found inside wrapper template."),null;let l=Array.from(r.classList).filter(a=>!a.match(/^is-h[2-6]$/)),s=r.querySelector('[heard-toc-element="link"]')||r.querySelector('[class*="fs-toc_link-h"]'),i=null;if(s){let a=Array.from(s.classList).find(m=>m.match(/fs-toc_link-h\d?/));a?i=a.replace(/\d$/,""):i=s.className.split(" ")[0]||null}let f=n.querySelector('[fs-toc-element="ix-trigger"]')||n.querySelector(".fs-toc_h-trigger"),p=f?f.cloneNode(!0):null;return t.innerHTML="",{linkContent:t,tableEl:e,wrapperBaseClasses:o,linkClasses:l,textDivBaseClass:i,ixTriggerTemplate:p}}function I(e,t){let n=document.createElement("div");t.wrapperBaseClasses.forEach(r=>n.classList.add(r)),e.level>=3&&e.level<=6&&n.classList.add(`is-h${e.level}`);let o=document.createElement("a");if(t.linkClasses.forEach(r=>o.classList.add(r)),o.href=`#${e.id}`,e.level>=3&&e.level<=6&&o.classList.add(`is-h${e.level}`),t.textDivBaseClass){let r=document.createElement("div");r.className=`${t.textDivBaseClass}${e.level}`,r.textContent=e.text,o.appendChild(r)}else o.textContent=e.text;return n.appendChild(o),t.ixTriggerTemplate&&n.appendChild(t.ixTriggerTemplate.cloneNode(!0)),n}function _(e,t){let n=e.filter(o=>!o.omitted);n.length!==0&&n.forEach(o=>{let r=I(o,t);t.linkContent.appendChild(r)})}function S(e){if(e.length===0)return console.warn("[Heard TOC] No headings found to build TOC"),!1;let t=$();if(!t)return!1;_(e,t);let n=e.filter(o=>!o.omitted).length;return console.log(`[Heard TOC] Populated ${n} TOC item(s)`),!0}function g(e){let t=parseFloat(e);return e.includes("rem")||e.includes("em")?t*16:e.includes("px")?t:e.includes("vh")?t/100*window.innerHeight:t}function N(){let e=getComputedStyle(document.documentElement).scrollPaddingTop;if(e&&e!=="auto"){let r=g(e);if(r>0)return r}let t=getComputedStyle(document.body).scrollPaddingTop;if(t&&t!=="auto"){let r=g(t);if(r>0)return r}let n=document.querySelectorAll('nav, header, [class*="nav"], [class*="header"], [data-role="navbar"]'),o=0;for(let r of n){let s=getComputedStyle(r).position;if(s==="fixed"||s==="sticky"){let i=r.getBoundingClientRect();i.top<10&&i.height>0&&(o=Math.max(o,i.bottom))}}return o}function R(){let e=document.querySelector('[heard-toc-element="table"]')||document.querySelector('[fs-toc-element="table"]')||document.querySelector(".fs-toc_link-content"),t,n,o=!1;if(e&&(t=e.getAttribute("fs-toc-offsettop")||e.getAttribute("heard-toc-offsettop")||void 0,n=e.getAttribute("fs-toc-offsetbottom")||e.getAttribute("heard-toc-offsetbottom")||void 0,o=e.getAttribute("fs-toc-hideurlhash")==="true"||e.getAttribute("heard-toc-hideurlhash")==="true"),!t&&!n){let r=document.querySelectorAll('[heard-toc-element="contents"], [fs-toc-element="contents"]');for(let l of r){let s=l.getAttribute("fs-toc-offsettop")||l.getAttribute("heard-toc-offsettop"),i=l.getAttribute("fs-toc-offsetbottom")||l.getAttribute("heard-toc-offsetbottom"),f=l.getAttribute("fs-toc-hideurlhash")==="true"||l.getAttribute("heard-toc-hideurlhash")==="true";if(s||i){t=s||void 0,n=i||void 0,o=f;break}f&&(o=!0)}}if(!t){let r=N();r>0&&(t=`${r+20}px`,console.log(`[Heard TOC] Auto-detected sticky nav offset: ${t}`))}return{offsetTop:t,offsetBottom:n,hideUrlHash:o}}function E(e){let t=document.querySelector(`a[href="#${e}"]`);return t||document.querySelector(`[data-toc-link="${e}"]`)}function D(e,t){let n=null;for(let o=0;o<t.length&&t[o].id!==e.id;o++)t[o].level<e.level&&!t[o].omitted&&(n=t[o]);return n}function H(e,t){if(e.level===2)return!0;let n=D(e,t);if(!n)return!0;let o=n.el.getBoundingClientRect(),r=window.scrollY,l=window.scrollY+o.top,s=window.scrollY+o.bottom;return l<=r+300||l>=r&&s<=r+window.innerHeight}function T(e,t){if(t.forEach(n=>{let o=E(n.id);o&&o.classList.remove("w--current")}),e){let n=t.find(o=>o.id===e);if(n&&H(n,t)){let o=E(e);if(o){o.classList.add("w--current");let r=o.closest('[heard-toc-element="ix-trigger"]')?.parentElement||o.querySelector('[heard-toc-element="ix-trigger"]');r&&r.dispatchEvent(new MouseEvent("click",{bubbles:!0}))}}}}function Y(e,t){let n=document.getElementById(e);if(!n)return;let o=t.offsetTop?g(t.offsetTop):0,r=t.offsetBottom?g(t.offsetBottom):0,l=n.getBoundingClientRect(),s=window.scrollY+l.top-o;if(window.scrollTo({top:Math.max(0,s),behavior:"smooth"}),!t.hideUrlHash){let i=new URL(window.location.href);i.hash=e,window.history.replaceState(null,"",i.toString())}}function P(e,t){e.forEach(n=>{let o=E(n.id);o&&o.addEventListener("click",r=>{let s=o.tagName==="A"?o.href:null;s&&s.includes("#")&&r.preventDefault(),Y(n.id,t)})})}function k(e){if(e.length===0)return;let t=R(),n=t.offsetTop?g(t.offsetTop):0,o=t.offsetBottom?g(t.offsetBottom):0,r=n>0?`-${n}px`:"0px",l=o>0?`-${o}px`:"0px",s=`${r} 0px ${l} 0px`,i=null,f=new IntersectionObserver(a=>{let m=null,d=0;for(let c of a)c.isIntersecting&&c.intersectionRatio>d&&(d=c.intersectionRatio,m=c);if(m!==null){let u=m.target.id;u&&u!==i&&(i=u,T(i,e))}else{let c=window.scrollY+n,u=null,y=1/0;for(let h of e){if(h.omitted||!H(h,e))continue;let O=h.el.getBoundingClientRect(),C=window.scrollY+O.top,b=Math.abs(C-c);C<=c+100&&b<y&&(y=b,u=h)}u!==null&&u.id!==i&&(i=u.id,T(i,e))}},{rootMargin:s,threshold:[0,.1,.5,1]});e.forEach(a=>{f.observe(a.el)}),P(e,t);let p=()=>{let a=window.scrollY+n,m=null;for(let d of e){if(d.omitted||!H(d,e))continue;let c=d.el.getBoundingClientRect();if(window.scrollY+c.top<=a+100)m=d.id;else break}m&&T(m,e)};p(),window.addEventListener("scroll",p,{passive:!0})}function x(){try{let e=w();if(e.length===0){console.warn('[Heard TOC] No headings found. Make sure you have elements with heard-toc-element="contents" containing h2-h6 headings.');return}if(!S(e)){console.warn("[Heard TOC] Failed to build TOC. Check your template structure.");return}k(e),console.log(`[Heard TOC] Initialized with ${e.length} heading(s)`)}catch(e){console.error("[Heard TOC] Error initializing:",e)}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",x):x();})();

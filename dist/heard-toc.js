/* Heard Custom Code - toc */
"use strict";(()=>{var v=/\[heard-toc-omit\]/gi,b=/\[heard-toc-h([2-6])\]/gi;function x(e){return e.toLowerCase().trim().replace(/[^\w\s-]/g,"").replace(/[\s_-]+/g,"-").replace(/^-+|-+$/g,"")}function A(e){let t=e,n=!1,r;v.test(e)&&(n=!0,t=t.replace(v,"").trim());let l=b.exec(e);return l&&(r=parseInt(l[1],10),t=t.replace(b,"").trim()),{cleanText:t,omitted:n,overrideLevel:r}}function I(e){let n=e.tagName.toLowerCase().match(/^h([2-6])$/);return n?parseInt(n[1],10):0}function y(){let e=document.querySelectorAll('[heard-toc-element="contents"]');if(e.length===0)return console.warn('[Heard TOC] No elements with heard-toc-element="contents" found'),[];let t=[],n=new Map;return e.forEach(r=>{r.querySelectorAll("h2, h3, h4, h5, h6").forEach(o=>{let i=I(o);if(i===0)return;let s=o.textContent||"",{cleanText:d,omitted:p,overrideLevel:m}=A(s);if(!d)return;let f=m||i,u=x(d);u||(u=`heading-${t.length+1}`);let c=u;if(n.has(c)){let a=n.get(c)+1;n.set(c,a),c=`${u}-${a}`}else n.set(c,1);o.id=c,t.push({el:o,level:f,text:d,id:c,omitted:p})})}),t}function O(){let e=document.querySelector('[heard-toc-element="link"]');if(!e)return console.warn('[Heard TOC] No element with heard-toc-element="link" found'),null;let t=new Map,n=e.parentElement,r=2;for(;n&&n!==document.body&&r<=6;){let o=n.cloneNode(!0),i=o.querySelector('[heard-toc-element="link"]');i&&i.remove(),t.set(r,o),n=n.parentElement,r++}let l=t.size>0?Math.max(...Array.from(t.keys())):2;return{linkEl:e,wrappers:t,maxLevel:Math.max(l,2)}}function N(e){let t=e.linkEl.cloneNode(!0);return t.removeAttribute("heard-toc-element"),t}function $(e,t,n){let r=e.wrappers.get(t);if(!r){let i=Array.from(e.wrappers.keys()).sort((d,p)=>d-p),s=i.find(d=>d>=t)||i[i.length-1];r=e.wrappers.get(s)}let l=r.cloneNode(!0),o=l;for(;o.children.length>0;){let i=o.children[0];if(i.tagName==="DIV"||i.tagName==="SPAN")o=i;else break}return o.appendChild(n),l}function B(e,t){let n=[],r=[];return e.forEach(l=>{if(l.omitted)return;let o=N(t);if(o.tagName==="A")o.href=`#${l.id}`;else{let s=o.querySelector("a")||o;s.tagName==="A"?s.href=`#${l.id}`:o.setAttribute("data-toc-link",l.id)}if(o.tagName==="A")o.textContent=l.text;else{let s=o.querySelector("a");s?s.textContent=l.text:o.textContent=l.text}let i=$(t,l.level,o);for(;r.length>0&&r[r.length-1].level>=l.level;)r.pop();r.length>0?r[r.length-1].wrapper.appendChild(i):n.push(i),r.push({level:l.level,wrapper:i})}),n}function q(e){let t=document.querySelector('[heard-toc-element="table"]');return t||e.linkEl.parentElement}function M(e){if(e.length===0)return console.warn("[Heard TOC] No headings found to build TOC"),!1;let t=O();if(!t)return!1;let n=B(e,t);if(n.length===0)return console.warn("[Heard TOC] No TOC items generated (all headings may be omitted)"),!1;let r=q(t);return r?(t.linkEl.remove(),r.innerHTML="",n.forEach(l=>r.appendChild(l)),!0):(console.warn("[Heard TOC] Could not find table container"),!1)}function h(e){let t=parseFloat(e);return e.includes("rem")||e.includes("em")?t*16:e.includes("px")?t:e.includes("vh")?t/100*window.innerHeight:t}function R(){let e=document.querySelector('[heard-toc-element="contents"]');if(!e)return{hideUrlHash:!1};let t=e.getAttribute("heard-toc-offsettop")||void 0,n=e.getAttribute("heard-toc-offsetbottom")||void 0,r=e.getAttribute("heard-toc-hideurlhash")==="true";return{offsetTop:t,offsetBottom:n,hideUrlHash:r}}function T(e){let t=document.querySelector(`a[href="#${e}"]`);return t||document.querySelector(`[data-toc-link="${e}"]`)}function g(e,t){if(t.forEach(n=>{let r=T(n.id);r&&r.classList.remove("w--current")}),e){let n=T(e);if(n){n.classList.add("w--current");let r=n.closest('[heard-toc-element="ix-trigger"]')?.parentElement||n.querySelector('[heard-toc-element="ix-trigger"]');r&&r.dispatchEvent(new MouseEvent("click",{bubbles:!0}))}}}function D(e,t){let n=document.getElementById(e);if(!n)return;let r=t.offsetTop?h(t.offsetTop):0,l=t.offsetBottom?h(t.offsetBottom):0,o=n.getBoundingClientRect(),i=window.scrollY+o.top-r;if(window.scrollTo({top:Math.max(0,i),behavior:"smooth"}),!t.hideUrlHash){let s=new URL(window.location.href);s.hash=e,window.history.replaceState(null,"",s.toString())}}function U(e,t){e.forEach(n=>{let r=T(n.id);r&&r.addEventListener("click",l=>{let i=r.tagName==="A"?r.href:null;i&&i.includes("#")&&l.preventDefault(),D(n.id,t)})})}function C(e){if(e.length===0)return;let t=R(),n=t.offsetTop?h(t.offsetTop):0,r=t.offsetBottom?h(t.offsetBottom):0,l=n>0?`-${n}px`:"0px",o=r>0?`-${r}px`:"0px",i=`${l} 0px ${o} 0px`,s=null,d=new IntersectionObserver(m=>{let f=null,u=0;for(let c of m)c.isIntersecting&&c.intersectionRatio>u&&(u=c.intersectionRatio,f=c);if(f!==null){let a=f.target.id;a&&a!==s&&(s=a,g(s,e))}else{let c=window.scrollY+n,a=null,E=1/0;for(let H of e){let k=H.el.getBoundingClientRect(),w=window.scrollY+k.top,L=Math.abs(w-c);w<=c&&L<E&&(E=L,a=H)}a!==null&&a.id!==s&&(s=a.id,g(s,e))}},{rootMargin:i,threshold:[0,.1,.5,1]});e.forEach(m=>{d.observe(m.el)}),U(e,t);let p=()=>{let m=window.scrollY+n,f=null;for(let u of e){let c=u.el.getBoundingClientRect();if(window.scrollY+c.top<=m+100)f=u.id;else break}f&&g(f,e)};p(),window.addEventListener("scroll",p,{passive:!0})}function S(){try{let e=y();if(e.length===0){console.warn('[Heard TOC] No headings found. Make sure you have elements with heard-toc-element="contents" containing h2-h6 headings.');return}if(!M(e)){console.warn("[Heard TOC] Failed to build TOC. Check your template structure.");return}C(e),console.log(`[Heard TOC] Initialized with ${e.length} heading(s)`)}catch(e){console.error("[Heard TOC] Error initializing:",e)}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",S):S();})();

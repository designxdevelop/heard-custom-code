/* Heard Custom Code - toc */
"use strict";(()=>{var v=/\[heard-toc-omit\]/gi,w=/\[heard-toc-h([2-6])\]/gi;function $(e){return e.toLowerCase().trim().replace(/[^\w\s-]/g,"").replace(/[\s_-]+/g,"-").replace(/^-+|-+$/g,"")}function B(e){let t=e,n=!1,o;v.test(e)&&(n=!0,t=t.replace(v,"").trim());let r=w.exec(e);return r&&(o=parseInt(r[1],10),t=t.replace(w,"").trim()),{cleanText:t,omitted:n,overrideLevel:o}}function _(e){let n=e.tagName.toLowerCase().match(/^h([2-6])$/);return n?parseInt(n[1],10):0}function S(){let e=document.querySelectorAll('[heard-toc-element="contents"]');if(e.length===0)return console.warn('[Heard TOC] No elements with heard-toc-element="contents" found'),[];let t=[],n=new Map;return e.forEach(o=>{o.querySelectorAll("h2, h3, h4, h5, h6").forEach(l=>{let i=_(l);if(i===0)return;let s=l.textContent||"",{cleanText:f,omitted:g,overrideLevel:a}=B(s);if(!f)return;let m=a||i,u=$(f);u||(u=`heading-${t.length+1}`);let c=u;if(n.has(c)){let d=n.get(c)+1;n.set(c,d),c=`${u}-${d}`}else n.set(c,1);l.id=c,t.push({el:l,level:m,text:f,id:c,omitted:g})})}),t}function I(){let e=document.querySelector('[heard-toc-element="table"]')||document.querySelector(".fs-toc_sidebar");if(!e)return console.warn('[Heard TOC] No TOC table element found. Add heard-toc-element="table".'),null;let t=e.querySelector(".fs-toc_link-content")||e.querySelector('[class*="toc_link-content"]');if(!t){let o=e.querySelector(".fs-toc_link-wrapper")||e.querySelector('[class*="toc_link-wrapper"]');return o?M(e,e,o):(console.warn("[Heard TOC] No link-content container found inside TOC table."),null)}let n=t.querySelector(":scope > .fs-toc_link-wrapper")||t.querySelector(".fs-toc_link-wrapper");return n?M(e,t,n):(console.warn("[Heard TOC] No fs-toc_link-wrapper found inside link-content."),null)}function M(e,t,n){let o=Array.from(n.classList).filter(a=>!a.match(/^is-h[2-6]$/)),r=n.querySelector(":scope > a.fs-toc_link")||n.querySelector(":scope > a")||n.querySelector("a.fs-toc_link")||n.querySelector("a");if(!r)return console.warn("[Heard TOC] No anchor element found inside wrapper template."),null;let l=Array.from(r.classList).filter(a=>!a.match(/^is-h[2-6]$/)),i=r.querySelector('[heard-toc-element="link"]')||r.querySelector('[class*="fs-toc_link-h"]'),s=null;if(i){let a=Array.from(i.classList).find(m=>m.match(/fs-toc_link-h\d?/));a?s=a.replace(/\d$/,""):s=i.className.split(" ")[0]||null}let f=n.querySelector('[fs-toc-element="ix-trigger"]')||n.querySelector(".fs-toc_h-trigger"),g=f?f.cloneNode(!0):null;return t.innerHTML="",{linkContent:t,tableEl:e,wrapperBaseClasses:o,linkClasses:l,textDivBaseClass:s,ixTriggerTemplate:g}}function N(e,t){let n=document.createElement("div");t.wrapperBaseClasses.forEach(r=>n.classList.add(r)),n.classList.add(`is-h${e.level}`);let o=document.createElement("a");if(t.linkClasses.forEach(r=>o.classList.add(r)),o.href=`#${e.id}`,e.level>=3&&e.level<=6&&o.classList.add(`is-h${e.level}`),t.textDivBaseClass){let r=document.createElement("div");r.className=`${t.textDivBaseClass}${e.level}`,r.textContent=e.text,o.appendChild(r)}else o.textContent=e.text;return n.appendChild(o),t.ixTriggerTemplate&&n.appendChild(t.ixTriggerTemplate.cloneNode(!0)),n}function R(e,t){let n=e.filter(o=>!o.omitted);n.length!==0&&n.forEach(o=>{let r=N(o,t);t.linkContent.appendChild(r)})}function x(e){if(e.length===0)return console.warn("[Heard TOC] No headings found to build TOC"),!1;let t=I();if(!t)return!1;R(e,t);let n=e.filter(o=>!o.omitted).length;return console.log(`[Heard TOC] Populated ${n} TOC item(s)`),!0}function T(e){let t=parseFloat(e);return e.includes("rem")||e.includes("em")?t*16:e.includes("px")?t:e.includes("vh")?t/100*window.innerHeight:t}function D(){let e=getComputedStyle(document.documentElement).scrollPaddingTop;if(e&&e!=="auto"){let r=T(e);if(r>0)return r}let t=getComputedStyle(document.body).scrollPaddingTop;if(t&&t!=="auto"){let r=T(t);if(r>0)return r}let n=0,o=document.querySelectorAll("nav, header");for(let r of o){let l=getComputedStyle(r);if(l.position==="fixed"||l.position==="sticky"){let i=r.getBoundingClientRect();i.top<10&&i.height>0&&(n=Math.max(n,i.bottom))}}if(n===0)for(let r of document.body.children){if(!(r instanceof HTMLElement))continue;let l=getComputedStyle(r);if(l.position==="fixed"||l.position==="sticky"){let i=r.getBoundingClientRect();i.top<10&&i.height>0&&(n=Math.max(n,i.bottom))}}return n}var p=-1;function k(e){if(p>=0)return p;if(e.offsetTop)p=T(e.offsetTop);else{let t=D();t>0?(p=t+20,console.log(`[Heard TOC] Auto-detected sticky nav offset: ${p}px`)):p=0}return p}function P(){let e=document.querySelector('[heard-toc-element="table"]')||document.querySelector('[fs-toc-element="table"]')||document.querySelector(".fs-toc_link-content"),t,n,o=!1;if(e&&(t=e.getAttribute("fs-toc-offsettop")||e.getAttribute("heard-toc-offsettop")||void 0,n=e.getAttribute("fs-toc-offsetbottom")||e.getAttribute("heard-toc-offsetbottom")||void 0,o=e.getAttribute("fs-toc-hideurlhash")==="true"||e.getAttribute("heard-toc-hideurlhash")==="true"),!t&&!n){let r=document.querySelectorAll('[heard-toc-element="contents"], [fs-toc-element="contents"]');for(let l of r){let i=l.getAttribute("fs-toc-offsettop")||l.getAttribute("heard-toc-offsettop"),s=l.getAttribute("fs-toc-offsetbottom")||l.getAttribute("heard-toc-offsetbottom"),f=l.getAttribute("fs-toc-hideurlhash")==="true"||l.getAttribute("heard-toc-hideurlhash")==="true";if(i||s){t=i||void 0,n=s||void 0,o=f;break}f&&(o=!0)}}return{offsetTop:t,offsetBottom:n,hideUrlHash:o}}function H(e){let t=document.querySelector(`a[href="#${e}"]`);return t||document.querySelector(`[data-toc-link="${e}"]`)}function Y(e,t){let n=null;for(let o=0;o<t.length&&t[o].id!==e.id;o++)t[o].level<e.level&&!t[o].omitted&&(n=t[o]);return n}function y(e,t){if(e.level===2)return!0;let n=Y(e,t);if(!n)return!0;let o=n.el.getBoundingClientRect(),r=window.scrollY,l=window.scrollY+o.top,i=window.scrollY+o.bottom;return l<=r+300||l>=r&&i<=r+window.innerHeight}function E(e,t){if(t.forEach(n=>{let o=H(n.id);o&&o.classList.remove("w--current")}),e){let n=t.find(o=>o.id===e);if(n&&y(n,t)){let o=H(e);if(o){o.classList.add("w--current");let r=o.closest('[heard-toc-element="ix-trigger"]')?.parentElement||o.querySelector('[heard-toc-element="ix-trigger"]');r&&r.dispatchEvent(new MouseEvent("click",{bubbles:!0}))}}}}function F(e,t){let n=document.getElementById(e);if(!n)return;let o=k(t),r=n.getBoundingClientRect(),l=window.scrollY+r.top-o;if(window.scrollTo({top:Math.max(0,l),behavior:"smooth"}),!t.hideUrlHash){let i=new URL(window.location.href);i.hash=e,window.history.replaceState(null,"",i.toString())}}function U(e,t){e.forEach(n=>{let o=H(n.id);o&&o.addEventListener("click",r=>{let i=o.tagName==="A"?o.href:null;i&&i.includes("#")&&r.preventDefault(),F(n.id,t)})})}function O(e){if(e.length===0)return;let t=P(),n=t.offsetBottom?T(t.offsetBottom):0;U(e,t),requestAnimationFrame(()=>{V(e,t,n)})}function V(e,t,n){let o=k(t),r=o>0?`-${o}px`:"0px",l=n>0?`-${n}px`:"0px",i=`${r} 0px ${l} 0px`,s=null,f=new IntersectionObserver(a=>{let m=null,u=0;for(let c of a)c.isIntersecting&&c.intersectionRatio>u&&(u=c.intersectionRatio,m=c);if(m!==null){let d=m.target.id;d&&d!==s&&(s=d,E(s,e))}else{let c=window.scrollY+o,d=null,C=1/0;for(let h of e){if(h.omitted||!y(h,e))continue;let q=h.el.getBoundingClientRect(),b=window.scrollY+q.top,L=Math.abs(b-c);b<=c+100&&L<C&&(C=L,d=h)}d!==null&&d.id!==s&&(s=d.id,E(s,e))}},{rootMargin:i,threshold:[0,.1,.5,1]});e.forEach(a=>{f.observe(a.el)});let g=()=>{let a=window.scrollY+o,m=null;for(let u of e){if(u.omitted||!y(u,e))continue;let c=u.el.getBoundingClientRect();if(window.scrollY+c.top<=a+100)m=u.id;else break}m&&E(m,e)};g(),window.addEventListener("scroll",g,{passive:!0})}function A(){try{let e=S();if(e.length===0){console.warn('[Heard TOC] No headings found. Make sure you have elements with heard-toc-element="contents" containing h2-h6 headings.');return}if(!x(e)){console.warn("[Heard TOC] Failed to build TOC. Check your template structure.");return}O(e),console.log(`[Heard TOC] Initialized with ${e.length} heading(s)`)}catch(e){console.error("[Heard TOC] Error initializing:",e)}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",A):A();})();

/* Heard Custom Code - toc */
"use strict";(()=>{var M=/\[heard-toc-omit\]/gi,k=/\[heard-toc-h([2-6])\]/gi;function _(e){return e.toLowerCase().trim().replace(/[^\w\s-]/g,"").replace(/[\s_-]+/g,"-").replace(/^-+|-+$/g,"")}function R(e){let t=e,n=!1,o;M.test(e)&&(n=!0,t=t.replace(M,"").trim());let r=k.exec(e);return r&&(o=parseInt(r[1],10),t=t.replace(k,"").trim()),{cleanText:t,omitted:n,overrideLevel:o}}function N(e){let n=e.tagName.toLowerCase().match(/^h([2-6])$/);return n?parseInt(n[1],10):0}function x(){let e=document.querySelectorAll('[heard-toc-element="contents"]');if(e.length===0)return console.warn('[Heard TOC] No elements with heard-toc-element="contents" found'),[];let t=[],n=new Map;return e.forEach(o=>{o.querySelectorAll("h2, h3, h4, h5, h6").forEach(i=>{let l=N(i);if(l===0)return;let s=i.textContent||"",{cleanText:a,omitted:c,overrideLevel:h}=R(s);if(!a)return;let p=h||l,f=_(a);f||(f=`heading-${t.length+1}`);let d=f;if(n.has(d)){let u=n.get(d)+1;n.set(d,u),d=`${f}-${u}`}else n.set(d,1);i.id=d,t.push({el:i,level:p,text:a,id:d,omitted:c})})}),t}function D(){let e=document.querySelector('[heard-toc-element="table"]')||document.querySelector(".fs-toc_sidebar");if(!e)return console.warn('[Heard TOC] No TOC table element found. Add heard-toc-element="table".'),null;let t=e.querySelector(".fs-toc_link-content")||e.querySelector('[class*="toc_link-content"]');if(!t){let o=e.querySelector(".fs-toc_link-wrapper")||e.querySelector('[class*="toc_link-wrapper"]');return o?O(e,e,o):(console.warn("[Heard TOC] No link-content container found inside TOC table."),null)}let n=t.querySelector(":scope > .fs-toc_link-wrapper")||t.querySelector(".fs-toc_link-wrapper");return n?O(e,t,n):(console.warn("[Heard TOC] No fs-toc_link-wrapper found inside link-content."),null)}function O(e,t,n){let o=Array.from(n.classList).filter(c=>!c.match(/^is-h[2-6]$/)),r=n.querySelector(":scope > a.fs-toc_link")||n.querySelector(":scope > a")||n.querySelector("a.fs-toc_link")||n.querySelector("a");if(!r)return console.warn("[Heard TOC] No anchor element found inside wrapper template."),null;let i=Array.from(r.classList).filter(c=>!c.match(/^is-h[2-6]$/)),l=r.querySelector('[heard-toc-element="link"]')||r.querySelector('[class*="fs-toc_link-h"]'),s=null;if(l){let c=Array.from(l.classList).find(h=>h.match(/fs-toc_link-h\d?/));c?s=c.replace(/\d$/,""):s=l.className.split(" ")[0]||null}return t.querySelectorAll(":scope > .fs-toc_link-wrapper").forEach(c=>c.remove()),{linkContent:t,tableEl:e,wrapperBaseClasses:o,linkClasses:i,textDivBaseClass:s}}function Y(e,t){let n=document.createElement("div");t.wrapperBaseClasses.forEach(r=>n.classList.add(r)),n.classList.add(`is-h${e.level}`);let o=document.createElement("a");if(t.linkClasses.forEach(r=>o.classList.add(r)),o.href=`#${e.id}`,e.level>=3&&e.level<=6&&o.classList.add(`is-h${e.level}`),t.textDivBaseClass){let r=document.createElement("div");r.className=`${t.textDivBaseClass}${e.level}`,r.textContent=e.text,o.appendChild(r)}else o.textContent=e.text;return n.appendChild(o),n}function P(e,t){let n=e.filter(o=>!o.omitted);n.length!==0&&n.forEach(o=>{let r=Y(o,t);t.linkContent.appendChild(r)})}function A(e){if(e.length===0)return console.warn("[Heard TOC] No headings found to build TOC"),!1;let t=D();if(!t)return!1;P(e,t);let n=e.filter(o=>!o.omitted).length;return console.log(`[Heard TOC] Populated ${n} TOC item(s)`),!0}function E(e){let t=parseFloat(e);return e.includes("rem")||e.includes("em")?t*16:e.includes("px")?t:e.includes("vh")?t/100*window.innerHeight:t}function F(){let e=getComputedStyle(document.documentElement).scrollPaddingTop;if(e&&e!=="auto"){let i=E(e);if(i>0)return i}let t=getComputedStyle(document.body).scrollPaddingTop;if(t&&t!=="auto"){let i=E(t);if(i>0)return i}let n=0;return document.querySelectorAll("nav, header").forEach(i=>{let l=getComputedStyle(i);if(l.position==="fixed"||l.position==="sticky"){let s=i.getBoundingClientRect();s.top<10&&s.height>0&&(n=Math.max(n,s.bottom))}}),n===0&&Array.from(document.body.children).forEach(i=>{if(i instanceof HTMLElement){let l=getComputedStyle(i);if(l.position==="fixed"||l.position==="sticky"){let s=i.getBoundingClientRect();s.top<10&&s.height>0&&(n=Math.max(n,s.bottom))}}}),document.querySelectorAll('.nav-w-banner, .nav-section, [data-wf--global-navigation--variant], nav[role="banner"], header[role="banner"]').forEach(i=>{let l=i.getBoundingClientRect();l.top<=8&&l.bottom>0&&l.height>0&&(n=Math.max(n,l.bottom))}),n}var T=0;function w(e){if(e.offsetTop)return E(e.offsetTop);let t=F();if(t>0){let n=t+20;n>T&&(T=n,console.log(`[Heard TOC] Auto-detected sticky nav offset: ${T}px`))}return T}function U(){let e=document.querySelector('[heard-toc-element="table"]')||document.querySelector('[fs-toc-element="table"]')||document.querySelector(".fs-toc_link-content"),t,n,o=!1;if(e&&(t=e.getAttribute("fs-toc-offsettop")||e.getAttribute("heard-toc-offsettop")||void 0,n=e.getAttribute("fs-toc-offsetbottom")||e.getAttribute("heard-toc-offsetbottom")||void 0,o=e.getAttribute("fs-toc-hideurlhash")==="true"||e.getAttribute("heard-toc-hideurlhash")==="true"),!t&&!n){let r=document.querySelectorAll('[heard-toc-element="contents"], [fs-toc-element="contents"]');for(let i=0;i<r.length;i++){let l=r[i],s=l.getAttribute("fs-toc-offsettop")||l.getAttribute("heard-toc-offsettop"),a=l.getAttribute("fs-toc-offsetbottom")||l.getAttribute("heard-toc-offsetbottom"),c=l.getAttribute("fs-toc-hideurlhash")==="true"||l.getAttribute("heard-toc-hideurlhash")==="true";if(s||a){t=s||void 0,n=a||void 0,o=c;break}c&&(o=!0)}}return{offsetTop:t,offsetBottom:n,hideUrlHash:o}}function v(e){let t=document.querySelector(`a[href="#${e}"]`);return t||document.querySelector(`[data-toc-link="${e}"]`)}function V(e,t){let n=null;for(let o=0;o<t.length&&t[o].id!==e.id;o++)t[o].level<e.level&&!t[o].omitted&&(n=t[o]);return n}function b(e,t){if(e.level===2)return!0;let n=V(e,t);if(!n)return!0;let o=n.el.getBoundingClientRect(),r=window.scrollY,i=window.scrollY+o.top,l=window.scrollY+o.bottom;return i<=r+300||i>=r&&l<=r+window.innerHeight}function y(e,t){if(t.forEach(n=>{let o=v(n.id);o&&o.classList.remove("w--current")}),e){let n=t.find(o=>o.id===e);if(n&&b(n,t)){let o=v(e);if(o){o.classList.add("w--current");let r=o.closest('[heard-toc-element="ix-trigger"]')?.parentElement||o.querySelector('[heard-toc-element="ix-trigger"]');r&&r.dispatchEvent(new MouseEvent("click",{bubbles:!0}))}}}}function q(e,t,n={}){let o=document.getElementById(e);if(!o)return;let r=n.behavior??"smooth",i=n.updateHash??!0,l=w(t),s=o.getBoundingClientRect(),a=Math.max(0,window.scrollY+s.top-l-8);if(window.scrollTo({top:a,behavior:r}),i&&!t.hideUrlHash){let c=new URL(window.location.href);c.hash=e,window.history.replaceState(null,"",c.toString())}}function H(e,t){let n=w(t),o=`${Math.max(0,n+8)}px`;e.forEach(r=>{r.el.style.scrollMarginTop=o})}function z(e){let t=()=>{let n=window.location.hash;if(!n||n.length<2)return;let o=decodeURIComponent(n.slice(1));!o||!document.getElementById(o)||q(o,e,{behavior:"auto",updateHash:!1})};requestAnimationFrame(()=>{requestAnimationFrame(()=>{t(),window.setTimeout(t,120)})}),window.addEventListener("hashchange",()=>{t()})}function W(e,t){e.forEach(n=>{let o=v(n.id);o&&o.addEventListener("click",r=>{let l=o.tagName==="A"?o.href:null;l&&l.includes("#")&&(r.preventDefault(),r.stopPropagation(),"stopImmediatePropagation"in r&&r.stopImmediatePropagation()),q(n.id,t)})})}function B(e){if(e.length===0)return;let t=U(),n=t.offsetBottom?E(t.offsetBottom):0;H(e,t),W(e,t),z(t);let o=()=>{requestAnimationFrame(()=>{requestAnimationFrame(()=>{j(e,t,n)})})};document.readyState==="complete"?o():window.addEventListener("load",o,{once:!0}),window.addEventListener("resize",()=>{H(e,t)},{passive:!0}),window.addEventListener("load",()=>{H(e,t)},{once:!0})}function j(e,t,n){let o=()=>w(t),r=o(),i=r>0?`-${r}px`:"0px",l=n>0?`-${n}px`:"0px",s=`${i} 0px ${l} 0px`,a=null,c=new IntersectionObserver(p=>{let f=null,d=0;for(let u of p)u.isIntersecting&&u.intersectionRatio>d&&(d=u.intersectionRatio,f=u);if(f!==null){let m=f.target.id;m&&m!==a&&(a=m,y(a,e))}else{let u=window.scrollY+o(),m=null,C=1/0;for(let g of e){if(g.omitted||!b(g,e))continue;let $=g.el.getBoundingClientRect(),S=window.scrollY+$.top,L=Math.abs(S-u);S<=u+100&&L<C&&(C=L,m=g)}m!==null&&m.id!==a&&(a=m.id,y(a,e))}},{rootMargin:s,threshold:[0,.1,.5,1]});e.forEach(p=>{c.observe(p.el)});let h=()=>{let p=window.scrollY+o(),f=null;for(let d of e){if(d.omitted||!b(d,e))continue;let u=d.el.getBoundingClientRect();if(window.scrollY+u.top<=p+100)f=d.id;else break}f&&y(f,e)};h(),window.addEventListener("scroll",h,{passive:!0})}function G(){let e=document.querySelector('[heard-toc-element="table"]')||document.querySelector(".fs-toc_sidebar");if(!e)return;let t=e.parentElement;for(;t&&t!==document.body;){let o=getComputedStyle(t).overflowY;(t.classList.contains("overflow-clip")||(o==="hidden"||o==="clip"))&&(t.style.overflowY="visible"),t=t.parentElement}}function I(){try{let e=x();if(e.length===0){console.warn('[Heard TOC] No headings found. Make sure you have elements with heard-toc-element="contents" containing h2-h6 headings.');return}if(!A(e)){console.warn("[Heard TOC] Failed to build TOC. Check your template structure.");return}G(),B(e),console.log(`[Heard TOC] Initialized with ${e.length} heading(s)`)}catch(e){console.error("[Heard TOC] Error initializing:",e)}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",I):I();})();

/* Heard Custom Code - toc */
"use strict";(()=>{var w=/\[heard-toc-omit\]/gi,M=/\[heard-toc-h([2-6])\]/gi;function x(e){return e.toLowerCase().trim().replace(/[^\w\s-]/g,"").replace(/[\s_-]+/g,"-").replace(/^-+|-+$/g,"")}function I(e){let t=e,n=!1,o;w.test(e)&&(n=!0,t=t.replace(w,"").trim());let r=M.exec(e);return r&&(o=parseInt(r[1],10),t=t.replace(M,"").trim()),{cleanText:t,omitted:n,overrideLevel:o}}function O(e){let n=e.tagName.toLowerCase().match(/^h([2-6])$/);return n?parseInt(n[1],10):0}function b(){let e=document.querySelectorAll('[heard-toc-element="contents"]');if(e.length===0)return console.warn('[Heard TOC] No elements with heard-toc-element="contents" found'),[];let t=[],n=new Map;return e.forEach(o=>{o.querySelectorAll("h2, h3, h4, h5, h6").forEach(c=>{let l=O(c);if(l===0)return;let s=c.textContent||"",{cleanText:f,omitted:m,overrideLevel:p}=I(s);if(!f)return;let u=p||l,d=x(f);d||(d=`heading-${t.length+1}`);let i=d;if(n.has(i)){let a=n.get(i)+1;n.set(i,a),i=`${d}-${a}`}else n.set(i,1);c.id=i,t.push({el:c,level:u,text:f,id:i,omitted:m})})}),t}function q(e){let t=[".fs-toc_link-wrapper",'[class*="toc_link-wrapper"]','[class*="toc-wrapper"]',".heard-toc-wrapper"];for(let n of t){let o=Array.from(e.querySelectorAll(n));if(o.length>0)return o}return Array.from(e.children).filter(n=>n instanceof HTMLElement)}function v(e){let t=[".fs-toc_link",'a[class*="toc_link"]',"a",'[heard-toc-element="link"]'];for(let n of t){let o=e.querySelector(n);if(o)return o}return e.tagName==="A"||e.hasAttribute("href")?e:null}function $(e,t){let n=[`.fs-toc_link-h${t}`,`h${t}[class*="toc_link"]`,`h${t}`];for(let o of n){let r=e.querySelector(o);if(r)return r}return null}function N(){let e=document.querySelector('[heard-toc-element="table"]')||document.querySelector(".fs-toc_link-content")||document.querySelector('[class*="toc_link-content"]');if(!e)return console.warn('[Heard TOC] No TOC container found. Add heard-toc-element="table" or .fs-toc_link-content'),null;let t=q(e),n=document.querySelector('[heard-toc-element="link"]')||e.querySelector(".fs-toc_link")||e.querySelector("a"),o=t.length>0?t[0]:e.querySelector(".fs-toc_link-wrapper")||e.firstElementChild;return!n||!o?(console.warn("[Heard TOC] Could not find template elements"),null):{container:e,wrapperElements:t,linkTemplate:n,wrapperTemplate:o}}function _(e,t){if(e.tagName==="A")e.href=`#${t.id}`;else{let o=e.querySelector("a");o?o.href=`#${t.id}`:(e.setAttribute("data-toc-link",t.id),e.style.cursor="pointer",e.addEventListener("click",()=>{let r=document.getElementById(t.id);r&&r.scrollIntoView({behavior:"smooth",block:"start"})}))}let n=$(e,t.level);if(n)n.textContent=t.text;else if(e.tagName==="A")e.textContent=t.text;else{let o=e.querySelector("a");o?o.textContent=t.text:e.textContent=t.text}}function B(e,t,n){if(n<e.wrapperElements.length)return e.wrapperElements[n];let o=e.wrapperTemplate.cloneNode(!0);o.removeAttribute("heard-toc-element");let r=v(o);return r&&r.hasAttribute("heard-toc-element"),o}function R(e,t){let n=e.filter(r=>!r.omitted);if(n.length===0){t.wrapperElements.forEach(r=>{r.style.display="none"});return}n.forEach((r,c)=>{let l=B(t,r,c);l.style.display="";let s=v(l);if(!s){s=t.linkTemplate.cloneNode(!0),s.removeAttribute("heard-toc-element");let f=l;for(;f.children.length>0;){let m=f.children[0];if(m.tagName==="DIV"||m.tagName==="SPAN")f=m;else break}f.appendChild(s)}_(s,r),c>=t.wrapperElements.length&&l.parentElement!==t.container&&t.container.appendChild(l)}),t.wrapperElements.forEach((r,c)=>{c>=n.length&&(r.style.display="none")});let o=t.container.querySelector('[heard-toc-element="link"]');if(o){let r=o.closest(".fs-toc_link-wrapper")||o.parentElement;t.wrapperElements.some(l=>l===r||l.contains(o))||o.remove()}}function C(e){if(e.length===0)return console.warn("[Heard TOC] No headings found to build TOC"),!1;let t=N();if(!t)return!1;R(e,t);let n=e.filter(o=>!o.omitted).length;return console.log(`[Heard TOC] Populated ${n} TOC item(s) using existing DOM elements`),!0}function h(e){let t=parseFloat(e);return e.includes("rem")||e.includes("em")?t*16:e.includes("px")?t:e.includes("vh")?t/100*window.innerHeight:t}function D(){let e=document.querySelector('[heard-toc-element="contents"]');if(!e)return{hideUrlHash:!1};let t=e.getAttribute("heard-toc-offsettop")||void 0,n=e.getAttribute("heard-toc-offsetbottom")||void 0,o=e.getAttribute("heard-toc-hideurlhash")==="true";return{offsetTop:t,offsetBottom:n,hideUrlHash:o}}function E(e){let t=document.querySelector(`a[href="#${e}"]`);return t||document.querySelector(`[data-toc-link="${e}"]`)}function g(e,t){if(t.forEach(n=>{let o=E(n.id);o&&o.classList.remove("w--current")}),e){let n=E(e);if(n){n.classList.add("w--current");let o=n.closest('[heard-toc-element="ix-trigger"]')?.parentElement||n.querySelector('[heard-toc-element="ix-trigger"]');o&&o.dispatchEvent(new MouseEvent("click",{bubbles:!0}))}}}function U(e,t){let n=document.getElementById(e);if(!n)return;let o=t.offsetTop?h(t.offsetTop):0,r=t.offsetBottom?h(t.offsetBottom):0,c=n.getBoundingClientRect(),l=window.scrollY+c.top-o;if(window.scrollTo({top:Math.max(0,l),behavior:"smooth"}),!t.hideUrlHash){let s=new URL(window.location.href);s.hash=e,window.history.replaceState(null,"",s.toString())}}function V(e,t){e.forEach(n=>{let o=E(n.id);o&&o.addEventListener("click",r=>{let l=o.tagName==="A"?o.href:null;l&&l.includes("#")&&r.preventDefault(),U(n.id,t)})})}function S(e){if(e.length===0)return;let t=D(),n=t.offsetTop?h(t.offsetTop):0,o=t.offsetBottom?h(t.offsetBottom):0,r=n>0?`-${n}px`:"0px",c=o>0?`-${o}px`:"0px",l=`${r} 0px ${c} 0px`,s=null,f=new IntersectionObserver(p=>{let u=null,d=0;for(let i of p)i.isIntersecting&&i.intersectionRatio>d&&(d=i.intersectionRatio,u=i);if(u!==null){let a=u.target.id;a&&a!==s&&(s=a,g(s,e))}else{let i=window.scrollY+n,a=null,T=1/0;for(let H of e){let A=H.el.getBoundingClientRect(),L=window.scrollY+A.top,y=Math.abs(L-i);L<=i&&y<T&&(T=y,a=H)}a!==null&&a.id!==s&&(s=a.id,g(s,e))}},{rootMargin:l,threshold:[0,.1,.5,1]});e.forEach(p=>{f.observe(p.el)}),V(e,t);let m=()=>{let p=window.scrollY+n,u=null;for(let d of e){let i=d.el.getBoundingClientRect();if(window.scrollY+i.top<=p+100)u=d.id;else break}u&&g(u,e)};m(),window.addEventListener("scroll",m,{passive:!0})}function k(){try{let e=b();if(e.length===0){console.warn('[Heard TOC] No headings found. Make sure you have elements with heard-toc-element="contents" containing h2-h6 headings.');return}if(!C(e)){console.warn("[Heard TOC] Failed to build TOC. Check your template structure.");return}S(e),console.log(`[Heard TOC] Initialized with ${e.length} heading(s)`)}catch(e){console.error("[Heard TOC] Error initializing:",e)}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",k):k();})();
